clc
input_file = "D:\1修士\６.Xsens_analysis\20241205\Modified_calibration_whole.xlsx";
Rthigh_x = readmatrix(input_file, 'Sheet','時系列データ 5m', 'Range','AJ:AJ');
Rthigh_z = readmatrix(input_file, 'Sheet','時系列データ 5m', 'Range','AK:AK');
Rshank_x = readmatrix(input_file, 'Sheet','時系列データ 5m', 'Range','AL:AL');
Rshank_z = readmatrix(input_file, 'Sheet','時系列データ 5m', 'Range','AM:AM');
Rfoot_x = readmatrix(input_file, 'Sheet','時系列データ 5m', 'Range','AN:AN');
Rfoot_y = readmatrix(input_file, 'Sheet','時系列データ 5m', 'Range','O:O');
Rtoe_z = readmatrix(input_file, 'Sheet','時系列データ 5m', 'Range','AG:AG');
Rtoe_x = readmatrix(input_file, 'Sheet','時系列データ 5m', 'Range','AT:AT');


Lthigh_x = readmatrix(input_file, 'Sheet','時系列データ 5m', 'Range','AO:AO');
Lthigh_z = readmatrix(input_file, 'Sheet','時系列データ 5m', 'Range','AP:AP');
Lshank_x = readmatrix(input_file, 'Sheet','時系列データ 5m', 'Range','AQ:AQ');
Lshank_z = readmatrix(input_file, 'Sheet','時系列データ 5m', 'Range','AR:AR');
Lfoot_x = readmatrix(input_file, 'Sheet','時系列データ 5m', 'Range','N:N');
Lfoot_y = readmatrix(input_file, 'Sheet','時系列データ 5m', 'Range','P:P');
Ltoe_z = readmatrix(input_file, 'Sheet','時系列データ 5m', 'Range','AH:AH');
Ltoe_x = readmatrix(input_file, 'Sheet','時系列データ 5m', 'Range','AU:AU');

df2 = readmatrix(input_file, 'Sheet','時系列データ 5m');
Rfootcontact = df2(2:end,11);
Lfootcontact = df2(2:end,12);
CoM_x = df2(2:end, 1);
CoM_x = CoM_x - CoM_x(1);
CoM_y = df2(2:end, 2);
CoM_z = df2(2:end, 3);
CoM_z_mean = mean(CoM_z);
Rcontact_frame = find([0;diff(Rfootcontact)==1;0]);
Rcontact_end_frame = find([0;diff(Rfootcontact)==-1;0]);
Lcontact_frame = find([0;diff(Lfootcontact)==1;0]);
Lcontact_end_frame = find([0;diff(Lfootcontact)==-1;0]);
if Rcontact_end_frame(1) < Rcontact_frame(1)
    Rcontact_end_frame = Rcontact_end_frame(2:end);
end
if Lcontact_end_frame(1) < Lcontact_frame(1)
    Lcontact_end_frame = Lcontact_end_frame(2:end);
end
time = 100;

% 色の設定: 60%部分は赤を基本に、40%部分は青を基本にして色を動的に変更
% 色の設定: 60%の部分の赤と40%の部分の青の色を変更
function traject(angle_x, angle_z, joint_name, x_lim, y_lim, CoM_x, CoM_z_mean, contact_frame, contact_end_frame)
    figure;
    for i = 1:length(contact_frame)-1
        % 関節位置と重心位置のデータ取得
        z_trajectory_stance = angle_z(contact_frame(i):contact_end_frame(i));
        x_trajectory_stance = angle_x(contact_frame(i):contact_end_frame(i));
        z_trajectory_swing = angle_z(contact_end_frame(i):contact_frame(i+1));
        x_trajectory_swing = angle_x(contact_end_frame(i):contact_frame(i+1));

        CoM_x_div_stance = CoM_x(contact_frame(i):contact_end_frame(i));
        CoM_x_div_swing = CoM_x(contact_end_frame(i):contact_frame(i+1));
        if i==1
            plot(x_trajectory_stance(1)-CoM_x_div_stance(1)-3, z_trajectory_stance(1),'Marker','o','DisplayName','初期値'); hold on;
            plot(0, CoM_z_mean, 'k.','MarkerSize', 20,'DisplayName','重心位置'); hold on;
        end

        x_trajectory_stance_adj = x_trajectory_stance - CoM_x_div_stance - 3;  
        plot(x_trajectory_stance_adj, z_trajectory_stance, 'Color', [1,0.5,0],'HandleVisibility','off'); hold on;
        x_trajectory_swing_adj = x_trajectory_swing - CoM_x_div_swing - 3;
        plot(x_trajectory_swing_adj, z_trajectory_swing, 'Color', [0,0,1], 'HandleVisibility','off');hold on;
        legend;
        % ラベル設定
        xlim(x_lim);
        ylim(y_lim);
        xlabel("重心位置に対する"+joint_name+"の位置　前後方向");
        ylabel('地面からの高さ m');

    end
end    
function compared_traject(Rangle_x, Rangle_z, Langle_x, Langle_z, joint_name, x_lim, y_lim, CoM_x, CoM_z_mean, Rcontact_frame, Rcontact_end_frame, Lcontact_frame, Lcontact_end_frame)
    % 定義: 補間後の統一データ点数
    unified_length = 100;
    x_R_stance_interp = [];
    z_R_stance_interp = [];
    x_L_stance_interp = [];
    z_L_stance_interp = [];
    
    figure;
    hold on;
    
    % 右脚立脚期の軌道を処理
    for i = 1:length(Rcontact_frame)-1
        z_Rtrajectory_stance = Rangle_z(Rcontact_frame(i):Rcontact_end_frame(i));
        x_Rtrajectory_stance = Rangle_x(Rcontact_frame(i):Rcontact_end_frame(i));
        RCoM_x_div_stance = CoM_x(Rcontact_frame(i):Rcontact_end_frame(i));
        
        % 軌道補正
        x_Rtrajectory_stance_adj = x_Rtrajectory_stance - RCoM_x_div_stance - 3;
        
        % 線形補間
        lin_space = linspace(1, length(x_Rtrajectory_stance_adj), unified_length);
        x_R_stance_interp(:, i) = interp1(1:length(x_Rtrajectory_stance_adj), x_Rtrajectory_stance_adj, lin_space, 'linear');
        z_R_stance_interp(:, i) = interp1(1:length(z_Rtrajectory_stance), z_Rtrajectory_stance, lin_space, 'linear');
    end
    % 右脚遊脚期の軌道を処理
    for i = 1:length(Rcontact_frame)-1
        z_Rtrajectory_swing = Rangle_z(Rcontact_end_frame(i):Rcontact_frame(i+1));
        x_Rtrajectory_swing = Rangle_x(Rcontact_end_frame(i):Rcontact_frame(i+1));
        RCoM_x_div_swing = CoM_x(Rcontact_end_frame(i):Rcontact_frame(i+1));
        
        % 軌道補正
        x_Rtrajectory_swing_adj = x_Rtrajectory_swing - RCoM_x_div_swing - 3;
        
        % 線形補間
        lin_space = linspace(1, length(x_Rtrajectory_swing_adj), unified_length);
        x_R_swing_interp(:, i) = interp1(1:length(x_Rtrajectory_swing_adj), x_Rtrajectory_swing_adj, lin_space, 'linear');
        z_R_swing_interp(:, i) = interp1(1:length(z_Rtrajectory_swing), z_Rtrajectory_swing, lin_space, 'linear');
    end
    
    % 左脚の軌道を処理
    for i = 1:length(Lcontact_frame)-1
        z_Ltrajectory_stance = Langle_z(Lcontact_frame(i):Lcontact_end_frame(i));
        x_Ltrajectory_stance = Langle_x(Lcontact_frame(i):Lcontact_end_frame(i));
        LCoM_x_div_stance = CoM_x(Lcontact_frame(i):Lcontact_end_frame(i));
        
        % 軌道補正
        x_Ltrajectory_stance_adj = x_Ltrajectory_stance - LCoM_x_div_stance - 3;
        
        % 線形補間
        lin_space = linspace(1, length(x_Ltrajectory_stance_adj), unified_length);
        x_L_stance_interp(:, i) = interp1(1:length(x_Ltrajectory_stance_adj), x_Ltrajectory_stance_adj, lin_space, 'linear');
        z_L_stance_interp(:, i) = interp1(1:length(z_Ltrajectory_stance), z_Ltrajectory_stance, lin_space, 'linear');
    end
    for i = 1:length(Lcontact_frame)-1
        z_Ltrajectory_swing = Langle_z(Lcontact_end_frame(i):Lcontact_frame(i+1));
        x_Ltrajectory_swing = Langle_x(Lcontact_end_frame(i):Lcontact_frame(i+1));
        LCoM_x_div_swing = CoM_x(Lcontact_end_frame(i):Lcontact_frame(i+1));
        
        % 軌道補正
        x_Ltrajectory_swing_adj = x_Ltrajectory_swing - LCoM_x_div_swing - 3;
        
        % 線形補間
        lin_space = linspace(1, length(x_Ltrajectory_swing_adj), unified_length);
        x_L_swing_interp(:, i) = interp1(1:length(x_Ltrajectory_swing_adj), x_Ltrajectory_swing_adj, lin_space, 'linear');
        z_L_swing_interp(:, i) = interp1(1:length(z_Ltrajectory_swing), z_Ltrajectory_swing, lin_space, 'linear');
    end

    % 平均軌道を計算
    mean_x_Rstance = mean(x_R_stance_interp, 2, 'omitnan');
    mean_z_Rstance = mean(z_R_stance_interp, 2, 'omitnan');
    mean_x_Rswing = mean(x_R_swing_interp, 2, 'omitnan');
    mean_z_Rswing = mean(z_R_swing_interp, 2, 'omitnan');
    mean_x_Lstance = mean(x_L_stance_interp, 2, 'omitnan');
    mean_z_Lstance = mean(z_L_stance_interp, 2, 'omitnan');
    mean_x_Lswing = mean(x_L_swing_interp, 2, 'omitnan');
    mean_z_Lswing = mean(z_L_swing_interp, 2, 'omitnan');

    % 軌道のプロット
    plot(mean_x_Rstance, mean_z_Rstance, '-','Color', [1,0,0], 'Marker', 'x','MarkerIndices', 1:20:100,'MarkerSize',8,'LineWidth', 1, 'DisplayName', '右脚:立脚期　平均軌道');
    plot(mean_x_Rswing, mean_z_Rswing, '-','Color', [1,0.5,0], 'Marker', 'x','MarkerIndices', 1:20:100,'MarkerSize',8,'LineWidth', 1, 'DisplayName', '右脚:遊脚期　平均軌道');
    plot(mean_x_Lstance, mean_z_Lstance, '-', 'Color', [0,0,1], 'Marker', '^','MarkerIndices', 1:20:100,'MarkerSize',3, 'LineWidth', 1, 'DisplayName', '左脚:立脚期　平均軌道');
    plot(mean_x_Lswing, mean_z_Lswing, '-', 'Color', [0,0.5,1], 'Marker', '^','MarkerIndices', 1:20:100,'MarkerSize',3,'LineWidth', 1, 'DisplayName', '左脚:遊脚期　平均軌道');

    % 重心位置をプロット
    plot(0, CoM_z_mean, 'k.', 'MarkerSize', 20, 'DisplayName', '重心位置');
    
    % グラフ設定
    legend;
    xlim(x_lim);
    ylim(y_lim);
    xlabel("重心位置に対する" + joint_name + "の位置 前後方向");
    ylabel('地面からの高さ m');
    title("左右脚の比較 - " + joint_name);

    exportgraphics(gcf, export_filename, 'Append', true);
    saveas(gcf, fullfile(indiv_figdir, ['左右比較', joint_name, '.jpeg']));
    close(gcf);
end


traject(Rthigh_x, Rthigh_z, "右大腿", [-0.2,0.2], [0.8,1], CoM_x, CoM_z_mean, Rcontact_frame, Rcontact_end_frame);
traject(Lthigh_x, Lthigh_z, "左大腿", [-0.2,0.2], [0.8,1], CoM_x, CoM_z_mean, Lcontact_frame, Lcontact_end_frame);
compared_traject(Rthigh_x, Rthigh_z, Lthigh_x, Lthigh_z, "大腿部の軌道比較", [-0.2,0.2], [0.8,1], CoM_x, CoM_z_mean, Rcontact_frame, Rcontact_end_frame, Lcontact_frame, Lcontact_end_frame);
traject(Rtoe_x, Rtoe_z, "右つま先", [-0.5,0.5], [0,1], CoM_x, CoM_z_mean, Rcontact_frame, Rcontact_end_frame);
traject(Ltoe_x, Ltoe_z, "左つま先", [-0.5,0.5], [0,1], CoM_x, CoM_z_mean, Lcontact_frame, Lcontact_end_frame);
compared_traject(Rtoe_x, Rtoe_z, Ltoe_x, Ltoe_z, "つま先の軌道比較", [-0.5,0.5], [0,1], CoM_x, CoM_z_mean, Rcontact_frame, Rcontact_end_frame, Lcontact_frame, Lcontact_end_frame);

%% 変更前のコード
% if i==1
%     plot(NaN, NaN, 'Color', [1, 0, 0], 'LineWidth', 1.5, 'DisplayName', '立脚期 (60%)'); % 赤
%     plot(NaN, NaN, 'Color', [0, 0, 1], 'LineWidth', 1.5, 'DisplayName', '遊脚期 (40%)'); % 青
%     title('関節の軌跡','FontSize', 14);
%     plot(0, CoM_z_mean, 'k.','MarkerSize', 20,'DisplayName','重心位置');
% end
% traject(Lthigh_x, Lthigh_z, "左大腿", CoM_x,CoM_z_mean, Lcontact_frame);
% traject(Lfoot_x, Lfoot_z, "左足関節",CoM_x,CoM_z_mean, Lcontact_frame);

% split_index_60 = round(0.6 * length(x_trajectory));  % 60%のインデックス
% orange_to_red = [1, 0.7, 0] + (1 - (i - 1) / (length(contact_frame) - 1)) * [0, -0.5, 0];  % 色の濃さ調整
% x_trajectory_1_60 = x_trajectory(1:split_index_60) - CoM_x_div(1:split_index_60) - 3;
% z_trajectory_60 = z_trajectory(1:split_index_60);  
% green_to_blue = [0, 1, 0.2] + (1 - (i - 1) / (length(contact_frame) - 1)) * [0, -1, 0.8];
% x_trajectory_1_40 = x_trajectory(split_index_60+1:end) - CoM_x_div(split_index_60+1:end) - 3;
% z_trajectory_40 = z_trajectory(split_index_60+1:end);
