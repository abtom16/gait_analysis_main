clc;
input_file_name = "D:\1修士\６.Xsens_analysis\20241107\Modified_1107asari_halfparalyzed.xlsx";
df = readmatrix(input_file_name, 'Sheet','時系列データ 11m');
[path, name, ~]=fileparts(input_file_name);
figure_path = fullfile(path, 'figure');

df2 = readmatrix(input_file_name, 'Sheet','時系列データ 5m');
Rfootcontact = df2(2:end,11);
Lfootcontact = df2(2:end,12);
Rcontact_frame = find([0;diff(Rfootcontact)==1;0]);
Lcontact_frame = find([0;diff(Lfootcontact)==1;0]);

Rknee_angle = df2(2:end,7);
Lknee_angle = df2(2:end,8);
Rankle_angle = df2(2:end,9);
Lankle_angle = df2(2:end,10);
Rhip_abduction = df2(2:end,29); % 外転
Lhip_abduction = df2(2:end,30);
L5_ay_5 = df2(2:end,22);

function Bothplot_joint_angle(Rangle_data, Langle_data, angle_label, y_lim, direction_max,direction_min,Rcontact_frame, Lcontact_frame, paralyzed_side)
    % angle_data: 各関節の角度データ
    % joint_name: 関節名 ('足関節' など)
    % angle_label: 関節角度のラベル ('足関節角度(°)' など)
    % y_lim: y軸の範囲
    % x_labels: x軸の目盛りラベル
    
    % 図の作成
    figure;
    set(gcf,'defaultLegendAutoUpdate','off');
    hold on;
    bg9 = fill([0,0.6,0.6,0],[y_lim(1),y_lim(1),y_lim(2),y_lim(2)],'b','EdgeColor', 'none','FaceAlpha',0.05,'DisplayName','立脚期');hold on;
    bg10 = fill([0.6,1,1,0.6],[y_lim(1),y_lim(1),y_lim(2),y_lim(2)],[1, 0.5, 0],'EdgeColor', 'none','FaceAlpha',0.05,'DisplayName','遊脚期');
    uistack(bg9, 'bottom');
    uistack(bg10, 'bottom');
    uniform_length = 100;
    % 線形補間とプロット
    for i = 1:length(Rcontact_frame)-1
        Rcurrent_cycle = Rangle_data(Rcontact_frame(i):Rcontact_frame(i+1));
        % disp(Rcurrent_cycle(1));
        Roriginal_x = linspace(0, 1, length(Rcurrent_cycle));
        Runiform_x = linspace(0, 1, uniform_length);
        Rresampled_angles(:, i) = interp1(Roriginal_x, Rcurrent_cycle, Runiform_x);
        % plot(Runiform_x, Rresampled_angles(:,i), '-k', 'HandleVisibility', 'off');
    end
    for i = 1:length(Lcontact_frame)-1
        Lcurrent_cycle = Langle_data(Lcontact_frame(i):Lcontact_frame(i+1));
        % disp(Lcurrent_cycle(1));
        Loriginal_x = linspace(0, 1, length(Lcurrent_cycle));
        Luniform_x = linspace(0, 1, uniform_length);
        Lresampled_angles(:, i) = interp1(Loriginal_x, Lcurrent_cycle, Luniform_x);
        % plot(Luniform_x, Lresampled_angles(:,i), '-k', 'HandleVisibility', 'off');
    end
    %% 麻痺側によって凡例の文字変更
    if strcmp(paralyzed_side, '右')
        right_label = '右平均 ＊麻痺側';
    else
        right_label = '左平均';
    end
    if strcmp(paralyzed_side, '左')
        left_label = '左平均 ＊麻痺側';
    else
        left_label = '左平均';
    end
    % 平均線のプロット
    Rmean_resampled = mean(Rresampled_angles, 2);
    plot(Runiform_x, Rmean_resampled, '-', 'Color',[1, 0.5, 0], 'DisplayName', right_label, 'LineWidth', 2);
    Lmean_resampled = mean(Lresampled_angles, 2);
    plot(Luniform_x, Lmean_resampled, '-b', 'DisplayName', left_label, 'LineWidth', 2);
    
    % 凡例設定
    legend('Location', 'Best');
    
    % 軸ラベル、目盛り設定
    xlabel('歩行周期(%)');
    xticks(0.1:0.1:1); 
    xticklabels(arrayfun(@(v) sprintf('%.0f%%', v*100), xticks, 'UniformOutput', false));
    ylabel(['右　',angle_label]);
    ylim(y_lim);
    
    % 方向のテキストと矢印
    text(-0.1, max(ylim)-0.1, direction_max, 'HorizontalAlignment', 'center', 'VerticalAlignment', 'middle', 'Rotation', 90);
    annotation('arrow', [0.09, 0.09], [0.85, 0.95]);
    text(-0.1, min(ylim), direction_min, 'HorizontalAlignment', 'center', 'VerticalAlignment', 'middle', 'Rotation', 90);
    annotation('arrow', [0.09, 0.09], [0.15, 0.05]);
    
    % 地面接触時のライン
    line([0 0], ylim, 'LineStyle', '-', 'Color', [0, 0, 1, 0.2], 'LineWidth', 1);
    text(0.03, max(ylim), '初期接地', 'Rotation', 90,'Color', 'blue', 'VerticalAlignment', 'bottom', 'HorizontalAlignment', 'right');
    line([0.1 0.1], ylim, 'LineStyle', '-', 'Color', [0, 0, 1, 0.2], 'LineWidth', 1);
    text(0.13, max(ylim), '反対側離地', 'Rotation', 90,'Color', 'blue', 'VerticalAlignment', 'bottom', 'HorizontalAlignment', 'right');
    line([0.3 0.3], ylim, 'LineStyle', '-', 'Color', [0, 0, 1, 0.2], 'LineWidth', 1);
    text(0.33, max(ylim), '踵離地', 'Rotation', 90,'Color', 'blue', 'VerticalAlignment', 'bottom', 'HorizontalAlignment', 'right');
    line([0.5 0.5], ylim, 'LineStyle', '-', 'Color', [0, 0, 1, 0.2], 'LineWidth', 1);
    text(0.53, max(ylim), '両脚支持', 'Rotation', 90, 'Color', 'blue', 'VerticalAlignment', 'bottom', 'HorizontalAlignment', 'right');
    line([0.6 0.6], ylim, 'LineStyle', '-', 'Color', [0, 0, 1, 0.2], 'LineWidth', 1);
    text(0.63, max(ylim), 'つま先離地', 'Rotation', 90,'Color', 'blue', 'VerticalAlignment', 'bottom', 'HorizontalAlignment', 'right');
    line([0.85 0.85], ylim, 'LineStyle', '-', 'Color', [0, 0, 1, 0.2], 'LineWidth', 1);
    text(0.83, max(ylim), '下腿垂直', 'Rotation', 90, 'Color', 'blue', 'VerticalAlignment', 'bottom', 'HorizontalAlignment', 'right');
    
    % グラフを保存
    % exportgraphics(gcf, export_filename, 'Append', true);
    % saveas(gcf, fullfile(indiv_figdir, ['右', angle_label, '.jpeg']));
    %close(gcf);
end


% 麻痺側の選択

Bothplot_joint_angle(Rknee_angle,Lknee_angle, '膝関節角度', [-10,60],'屈曲方向(°)','伸展方向', Rcontact_frame,Lcontact_frame,paralyzed_side);

